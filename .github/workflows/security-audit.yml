name: üõ°Ô∏è Zero Trust Security Audit

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  schedule:
    - cron: '0 3 * * *' # Minden hajnalban 3-kor fut (am√≠g alszol)

jobs:
  # 1. JOB: F√ºgg≈ës√©g Audit (Java & General)
  dependency-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Java k√∂rnyezet (ha Maven projekt)
      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      # Trivy Security Scanner (Ez a C++ √©s Java hib√°kat is fogja!)
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '1' # Elt√∂ri a buildet, ha hib√°t tal√°l!
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  # 2. JOB: Maven Specifikus SQL Ellen≈ërz√©s (A te k√©r√©sedre)
  maven-sql-check:
    runs-on: ubuntu-latest
    needs: dependency-audit
    if: hashFiles('pom.xml') != '' # Csak ha van pom.xml
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Check for Unwanted Transitive SQL Deps
        run: |
          echo "üîç Checking for hidden SQL dependencies..."
          mvn dependency:tree -Dincludes=*:*sql*,*:*jdbc*,*:*hibernate* > deps.txt
          
          # Itt defini√°lhatjuk, mi az elfogadott. 
          # Ha tal√°ln√°nk olyat, ami NEM PostgreSQL, riasztan√°nk.
          if grep -i "mysql" deps.txt; then
            echo "‚ùå ERROR: MySQL dependency found! We are a Postgres shop!"
            exit 1
          fi
          
          if grep -i "h2" deps.txt; then
            echo "‚ö†Ô∏è WARNING: H2 database found. Ensure scope is 'test' only!"
            # Itt lehet szigor√∫bbnak lenni √©s exit 1-et nyomni
          fi
          
          echo "‚úÖ SQL Dependency Check Passed."
