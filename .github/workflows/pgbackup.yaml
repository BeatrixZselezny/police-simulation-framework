name: PostgreSQL Backup Test

on:
  push:
    paths:
      - .github/workflows/pgbackup.yaml
  workflow_dispatch:

jobs:
  db-dump-test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Repo klÃ³nozÃ¡sa
        uses: actions/checkout@v3

      - name: ğŸ˜ PostgreSQL telepÃ­tÃ©se Ã©s indÃ­tÃ¡sa
        run: |
          sudo apt update
          sudo apt install -y postgresql postgresql-contrib
          sudo pg_ctlcluster 14 main start

      - name: ğŸ› ï¸ TesztadatbÃ¡zis lÃ©trehozÃ¡sa
        run: |
          sudo -u postgres createdb receptek_utf8_test

      - name: ğŸ“¤ Dump kÃ©szÃ­tÃ©se
        run: |
          echo "CREATE TABLE test (id SERIAL PRIMARY KEY, name TEXT);" | sudo -u postgres psql receptek_utf8_test
          sudo -u postgres pg_dump receptek_utf8_test > dump.sql

      - name: ğŸ“¥ Dump visszatÃ¶ltÃ©se Ãºj adatbÃ¡zisba
        run: |
          sudo -u postgres createdb restore_test
          sudo -u postgres psql restore_test < dump.sql

      - name: ğŸ§¹ TakarÃ­tÃ¡s
        run: |
          sudo -u postgres dropdb receptek_utf8_test
          sudo -u postgres dropdb restore_test
          rm -f dump.sql

      - name: ğŸ“ Post - sikeres teszt log
        run: echo "âœ… PostgreSQL backup & restore teszt sikeres."

  notify-on-failure:
    needs: db-dump-test
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš¨ Ã‰rtesÃ­tÃ©s hibÃ¡rÃ³l
        run: echo "âŒ Sikertelen lett a PostgreSQL backup workflow. NÃ©zd meg a logokat!"

