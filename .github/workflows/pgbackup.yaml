name: PostgreSQL Dump Teszt

on:
  push:
    paths:
      - 'sql_scripts/db_backup/**'
  schedule:
    - cron: '0 23 * * *' # Ez UTC 23:00, azaz magyar idő szerint pont éjfél!

jobs:
  db-dump-test:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Repo klónozása
        uses: actions/checkout@v3

      - name: 🐘 PostgreSQL telepítése
        run: |
          sudo apt update
          sudo apt install -y postgresql postgresql-contrib

      - name: 🔄 Adatbázis létrehozása teszthez
        run: |
          sudo -u postgres createdb receptek_utf8_test

      - name: 💾 Dump visszatöltése teszt adatbázisba
        run: |
          sudo -u postgres psql -d receptek_utf8_test -f sql_scripts/db_backup/receptek_utf8_dump.sql

      - name: 🧹 Takarítás
        run: |
          sudo -u postgres dropdb receptek_utf8_test

  notify-on-failure:
  if: failure()
  runs-on: ubuntu-latest
  steps:
    - name: ❌ Send failure notification
      run: |
        echo "🔴 PostgreSQL backup or restore failed. Check logs here: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

