name: PostgreSQL Backup Test

on:
  push:

jobs:
  db-dump-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: bea
          POSTGRES_PASSWORD: titok
          POSTGRES_DB: receptek
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Repo kl√≥noz√°sa
      uses: actions/checkout@v4

    - name: V√°rakoz√°s PostgreSQL-re
      run: |
        echo "V√°runk a DB-re..."
        sleep 10

    - name: Tesztadatb√°zis l√©trehoz√°sa
      run: |
        psql -h localhost -U bea -d receptek -c "CREATE TABLE test (id SERIAL PRIMARY KEY, name TEXT);"
      env:
        PGPASSWORD: titok

    - name: Dump k√©sz√≠t√©se
      run: |
        pg_dump -h localhost -U bea -d receptek -f dump.sql
      env:
        PGPASSWORD: titok

    - name: Dump visszat√∂lt√©se √∫j adatb√°zisba
      run: |
        psql -h localhost -U bea -c "CREATE DATABASE receptek_restore;"
        psql -h localhost -U bea -d receptek_restore -f dump.sql
      env:
        PGPASSWORD: titok

    - name: Takar√≠t√°s
      run: rm -f dump.sql

    - name: Post - sikeres teszt log
      run: echo "Sikeresen ment a backup & restore teszt! üéâ"
      
  notify-on-failure:
    needs: db-dump-test
    if: failure()
    runs-on: ubuntu-latest
    steps:
    - name: √ârtes√≠t√©s sikertelen ment√©sr≈ël
      run: echo "‚ùå PostgreSQL ment√©s/restore sikertelen volt!"

